; generated by chef for <%= node[:fqdn] %>

$TTL <%= @zone['times']['ttl'] %>
$ORIGIN <%= @zone['id'].gsub(/_/,'.') %>.

@ IN  SOA <%= @zone['ns'][0].keys[0] %>. <%= @zone['admin'].gsub(/@/,".") %>. (
                  <%= @zone['serial'] %> ; Serial
                  <%= @zone['times']['refresh'] %> ; Refresh
                  <%= @zone['times']['retry'] %> ; Retry
                  <%= @zone['times']['expire'] %> ; Expire
                  <%= @zone['times']['negative_cache'] %> ; Negative Cache-TTL
                  )
                                                    
                  <% @zone['ns'].select { |s| !s.fetch("exclude_from_ns_list", false) }.each do |ns| %>
                  IN  NS  <%= ns.keys[0] %>.
                  <% end -%>
                                              
                  <% if @zone['mx'] %>
                  <% @zone['mx'].each do |mx| %>
                  IN  MX  <%= mx.values[0] %> <%= mx.keys[0] %>. 
                  <% end -%>
                  <% end -%>

<% @zone['host'].each do |host| %>
  <% host.each do |k,v| %>
    <% if k.eql?('alias') %>
      <% v.each do |hostalias| %>
<%= hostalias %> IN CNAME <%= host.keys[0] %>
      <% end -%>
    <% elsif k.eql?('*') %>
<%= "#{k}.#{@zone['id'].gsub(/_/,'.')}" %>. IN A <%= v %>
    <% else %>
      <% unless v.eql?("") %>
<%= k.match(/([a-z\-0-9\.\*@]+)_*/)[1] %> IN A <%= v %>
      <% end %>
    <% end -%>
  <% end -%>
<% end -%>

<% if @zone.has_key? 'spf' %>
  <% @zone['spf'].each do |spf| %>
<%= "#{@zone['id'].gsub(/_/,'.')}" %>. IN TXT "<%= spf %>"
<%= "#{@zone['id'].gsub(/_/,'.')}" %>. IN SPF "<%= spf %>"
  <% end -%>
<% end -%>

<% if @zone.has_key? 'dkim' %>
  <% @zone['dkim'].each do |selector, value| %>
<%= "#{selector}.#{@zone['id'].gsub(/_/,'.')}. IN TXT \"#{value}\"" %>
  <% end -%>
<% end -%>

<% if @zone.has_key? 'dmarc' %>
<%= "_dmarc.#{@zone['id'].gsub(/_/,'.')}. IN TXT \"#{@zone['dmarc']}\"" %>
<% end -%>
