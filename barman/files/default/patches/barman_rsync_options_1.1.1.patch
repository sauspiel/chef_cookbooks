From 4948e8915327924cd18595525ed54efb25a20e36 Mon Sep 17 00:00:00 2001
From: Holger Amann <holger@sauspiel.de>
Date: Wed, 5 Dec 2012 17:34:03 +0100
Subject: [PATCH 1/2] Adding rsync_options for applying arguments to rsync
 command


Signed-off-by: Holger Amann <holger@sauspiel.de>
---
 barman/backup.py           |    2 +-
 barman/command_wrappers.py |   11 ++++++++---
 barman/config.py           |    2 ++
 barman/server.py           |    1 +
 4 files changed, 12 insertions(+), 4 deletions(-)

diff --git a/barman/backup.py b/barman/backup.py
index 8c0b292..08dabc6 100644
--- a/barman/backup.py
+++ b/barman/backup.py
@@ -807,7 +807,7 @@ class BackupManager(object):
         :param backup_info: the backup information structure
         '''
         backup_dest = os.path.join(backup_info.get_basebackup_directory(), 'pgdata')
-        rsync = RsyncPgData(ssh=self.server.ssh_command, ssh_options=self.server.ssh_options)
+        rsync = RsyncPgData(ssh=self.server.ssh_command, ssh_options=self.server.ssh_options, rsync_options=self.server.rsync_options)
         retval = rsync(':%s/' % backup_info.pgdata, backup_dest)
         if retval not in (0, 24):
             msg = "ERROR: data transfer failure"
diff --git a/barman/command_wrappers.py b/barman/command_wrappers.py
index 9ddb4c0..43cba15 100644
--- a/barman/command_wrappers.py
+++ b/barman/command_wrappers.py
@@ -103,11 +103,16 @@ class Rsync(Command):
     This class is a wrapper for the rsync system command,
     which is used vastly by barman
     '''
-    def __init__(self, rsync='rsync', args=[], ssh=None, ssh_options=None, debug=False):
+    def __init__(self, rsync='rsync', args=[], ssh=None, ssh_options=None, debug=False, rsync_options=None):
         if ssh:
             options = ['-e', self._cmd_quote(ssh, ssh_options)] + args
         else:
             options = args
+
+        if rsync_options != None and len(rsync_options) > 0:
+          options = options + rsync_options
+
+
         Command.__init__(self, rsync, options, debug=debug)
 
     def from_file_list(self, filelist, src, dst):
@@ -135,11 +140,11 @@ class Rsync(Command):
 class RsyncPgData(Rsync):
     ''' This class is a wrapper for rsync, specialized in Postgres data directory syncing
     '''
-    def __init__(self, rsync='rsync', args=[], ssh=None, ssh_options=None, debug=False):
+    def __init__(self, rsync='rsync', args=[], ssh=None, ssh_options=None, debug=False, rsync_options=None):
         options = ['-rLKpts', '--delete-excluded', '--inplace',
                    '--exclude=/pg_xlog/*',
                    '--exclude=/pg_log/*',
                    '--exclude=/postmaster.pid'
                    ] + args
-        Rsync.__init__(self, rsync, options, ssh, ssh_options, debug)
+        Rsync.__init__(self, rsync, options, ssh, ssh_options, debug, rsync_options)
 
diff --git a/barman/config.py b/barman/config.py
index 23c49fb..0b0f63c 100644
--- a/barman/config.py
+++ b/barman/config.py
@@ -37,6 +37,7 @@ class Server(object):
         'compression', 'custom_compression_filter',
         'custom_decompression_filter', 'retention_policy',
         'wal_retention_policy', 'pre_backup_script', 'post_backup_script',
+        'rsync_options',
     ]
 
     BARMAN_KEYS = ['compression', 'custom_compression_filter',
@@ -51,6 +52,7 @@ class Server(object):
         'wals_directory': r'%(backup_directory)s/wals',
         'incoming_wals_directory': r'%(backup_directory)s/incoming',
         'lock_file': r'%(backup_directory)s/%(name)s.lock',
+        'rsync_options': 'None',
     }
 
     def __init__(self, config, name):
diff --git a/barman/server.py b/barman/server.py
index 5dee701..87dc674 100644
--- a/barman/server.py
+++ b/barman/server.py
@@ -44,6 +44,7 @@ class Server(object):
         self.ssh_options = config.ssh_command.split()
         self.ssh_command = self.ssh_options.pop(0)
         self.ssh_options.extend("-o BatchMode=yes -o StrictHostKeyChecking=no".split())
+        self.rsync_options = config.rsync_options.split()
         self.backup_manager = BackupManager(self)
         self.configuration_files = None
 
-- 
1.7.9.6 (Apple Git-31.1)


From 8951ab4a0413d24e15ae708aeeb4b8a010ce0019 Mon Sep 17 00:00:00 2001
From: Holger Amann <holger@sauspiel.de>
Date: Wed, 12 Dec 2012 08:46:24 +0100
Subject: [PATCH 2/2] Fixing default value for rsync_options (should be ''
 instead of 'None'


Signed-off-by: Holger Amann <holger@sauspiel.de>
---
 barman/config.py |    2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/barman/config.py b/barman/config.py
index 0b0f63c..60ffb79 100644
--- a/barman/config.py
+++ b/barman/config.py
@@ -52,7 +52,7 @@ class Server(object):
         'wals_directory': r'%(backup_directory)s/wals',
         'incoming_wals_directory': r'%(backup_directory)s/incoming',
         'lock_file': r'%(backup_directory)s/%(name)s.lock',
-        'rsync_options': 'None',
+        'rsync_options': '',
     }
 
     def __init__(self, config, name):
-- 
1.7.9.6 (Apple Git-31.1)

