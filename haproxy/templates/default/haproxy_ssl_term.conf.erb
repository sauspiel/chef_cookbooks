global
  log /dev/log local0 info
  log /dev/log local1 notice
  maxconn <%= @config.maxconn %>
  user <%= @node.haproxy.user %>
  group <%= @node.haproxy.group %>
  pidfile /var/run/haproxy/haproxy_ssl_term_<%= @config.name %>.pid
  stats socket /var/run/haproxy/haproxy_ssl_term_<%= @config.name %>.stats level admin

defaults
  log global
  option dontlognull
  option contstats

  balance <%= @config.balance %>

  timeout connect <%= @config.global_timeout_connect %>
  timeout client <%= @config.global_timeout_client %>
  timeout server <%= @config.global_timeout_server %>

  mode <%= @config.mode %>
  <% if @config.mode == 'tcp' %>
  option tcpka
  option srvtcpka
  option tcplog
  <% else %>
  option httplog
  <% end -%>

  frontend <%= @config.name %>
    bind <%= "#{@config.frontend_bind_address}:#{@config.frontend_bind_port}" %> ssl <%= haproxy_ssl_certificates_to_multi_crt_string(@config.ssl_certificates) %>
    <% @config.acls.each do |acl| %>
    acl <%= acl %>
    <% end -%>
    <% @config.use_backends.each do |use_backend| %>
    use_backend <%= use_backend %>
    <% end -%>
    default_backend <%= @config.backends.keys.first %>

  <% @config.backends.each do |name, conf| -%>
  backend <%= name %>
    <% conf[:servers].each do |server, server_conf| %>
    server <%= "#{server} #{server_conf[:address]}:#{server_conf[:port]} #{server_conf[:options].join(" ")}" %> <%= 'send-proxy' if @config.mode == 'tcp' && @config.forward_source_ip %>
    <% end -%>
    <%= 'option forwardfor' if @config.mode == 'http' && @config.forward_source_ip %> <%= "except #{@config.forward_source_ip_except}" if @config.forward_source_ip_except %>

  <% end -%>

  listen <%= "#{@config.name}_admin #{@config.admin_bind_address}:#{@config.admin_bind_port}" %>
    mode http
    stats enable
    stats refresh 30s
    stats show-node
    stats show-legends
    stats show-desc
    stats uri /
    <% if @config.stats_auth_user %>
    <%= 'stats auth ' "#{@config.stats_auth_user}:#{@config.stats_auth_password}" %>
    <% end -%>
